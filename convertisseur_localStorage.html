<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertisseur localStorage ‚Üí FinanceApp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }
        h1 {
            color: #4f46e5;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .step {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4f46e5;
        }
        .step h3 {
            color: #4f46e5;
            margin-bottom: 10px;
        }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background: #4338ca;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            margin-top: 10px;
        }
        .success {
            background: #10b981;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        .error {
            background: #ef4444;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        .warning {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            color: #92400e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Convertisseur localStorage</h1>
        <p class="subtitle">Transformez vos anciennes donn√©es en format compatible FinanceApp</p>

        <div class="warning">
            <strong>‚ö†Ô∏è Important :</strong> Cette page doit √™tre ouverte sur la M√äME URL que votre ancienne application (celle qui contient localStorage). Sinon, collez directement vos donn√©es JSON ci-dessous.
        </div>

        <div class="step">
            <h3>üìã √âtape 1 : Extraire localStorage</h3>
            <p>Si vous √™tes sur l'ancienne app, cliquez pour extraire automatiquement :</p>
            <button onclick="extractLocalStorage()">Extraire localStorage</button>
        </div>

        <div class="step">
            <h3>üìù √âtape 2 : OU Coller vos donn√©es JSON</h3>
            <p>Si vous avez d√©j√† un export JSON de votre ancienne app, collez-le ici :</p>
            <textarea id="oldData" placeholder='{"accounts": [...], "transactions": [...], ...}'></textarea>
            <button onclick="convertData()">Convertir au nouveau format</button>
        </div>

        <div class="step">
            <h3>‚úÖ √âtape 3 : Donn√©es converties</h3>
            <textarea id="newData" placeholder="Les donn√©es converties appara√Ætront ici..." readonly></textarea>
            <button id="downloadBtn" onclick="downloadJSON()" disabled>üì• T√©l√©charger le fichier JSON</button>
            <button id="importBtn" onclick="importToApp()" disabled>üöÄ Importer directement dans l'app</button>
        </div>

        <div id="success" class="success"></div>
        <div id="error" class="error"></div>
    </div>

    <script>
        function extractLocalStorage() {
            try {
                const data = {};
                
                // Extraire toutes les cl√©s localStorage li√©es √† l'app financi√®re
                const keys = ['accounts', 'transactions', 'investments', 'goals', 'debts', 'receivables', 'products', 'shopping_lists', 'bank_connections'];
                
                keys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) {
                        try {
                            data[key] = JSON.parse(value);
                        } catch (e) {
                            console.warn(`Erreur parsing ${key}:`, e);
                        }
                    }
                });

                if (Object.keys(data).length === 0) {
                    throw new Error('Aucune donn√©e trouv√©e dans localStorage');
                }

                document.getElementById('oldData').value = JSON.stringify(data, null, 2);
                showSuccess('‚úÖ Donn√©es extraites avec succ√®s ! Cliquez sur "Convertir" maintenant.');
                
                // Auto-convert
                convertData();
            } catch (error) {
                showError('‚ùå Erreur : ' + error.message + '. Essayez de coller vos donn√©es manuellement.');
            }
        }

        function convertData() {
            try {
                const oldDataText = document.getElementById('oldData').value;
                if (!oldDataText.trim()) {
                    throw new Error('Aucune donn√©e √† convertir');
                }

                const oldData = JSON.parse(oldDataText);
                const newData = {
                    accounts: [],
                    transactions: [],
                    investments: [],
                    goals: [],
                    debts: [],
                    receivables: [],
                    products: [],
                    shopping_lists: [],
                    bank_connections: []
                };

                // Convertir les comptes
                if (oldData.accounts && Array.isArray(oldData.accounts)) {
                    newData.accounts = oldData.accounts.map(acc => ({
                        id: acc.id || generateUUID(),
                        name: acc.name || 'Compte sans nom',
                        type: acc.type || 'checking',
                        currency: acc.currency || 'EUR',
                        initial_balance: parseFloat(acc.initial_balance || acc.balance || 0),
                        current_balance: parseFloat(acc.current_balance || acc.balance || 0),
                        icon: acc.icon || 'wallet',
                        color: acc.color || '#4f46e5',
                        is_excluded_from_total: acc.is_excluded_from_total || false,
                        created_at: formatDate(acc.created_at || acc.createdAt || new Date())
                    }));
                }

                // Convertir les transactions
                if (oldData.transactions && Array.isArray(oldData.transactions)) {
                    newData.transactions = oldData.transactions.map(txn => ({
                        id: txn.id || generateUUID(),
                        account_id: txn.account_id || txn.accountId || (newData.accounts[0]?.id || 'unknown'),
                        type: txn.type || 'expense',
                        amount: parseFloat(txn.amount || 0),
                        category: txn.category || 'Divers',
                        description: txn.description || txn.desc || 'Sans description',
                        date: formatDate(txn.date || new Date()),
                        is_recurring: txn.is_recurring || txn.isRecurring || false,
                        recurring_frequency: txn.recurring_frequency || txn.frequency || null,
                        tags: txn.tags || [],
                        created_at: formatDate(txn.created_at || txn.createdAt || new Date())
                    }));
                }

                // Convertir les investissements
                if (oldData.investments && Array.isArray(oldData.investments)) {
                    newData.investments = oldData.investments.map(inv => ({
                        id: inv.id || generateUUID(),
                        name: inv.name || 'Investissement',
                        symbol: inv.symbol || inv.ticker || 'N/A',
                        type: inv.type || 'stock',
                        quantity: parseFloat(inv.quantity || 0),
                        average_price: parseFloat(inv.average_price || inv.avgPrice || 0),
                        current_price: parseFloat(inv.current_price || inv.price || 0),
                        currency: inv.currency || 'EUR',
                        operations: inv.operations || [],
                        created_at: formatDate(inv.created_at || new Date())
                    }));
                }

                // Convertir les objectifs
                if (oldData.goals && Array.isArray(oldData.goals)) {
                    newData.goals = oldData.goals.map(goal => ({
                        id: goal.id || generateUUID(),
                        name: goal.name || 'Objectif',
                        target_amount: parseFloat(goal.target_amount || goal.target || 0),
                        current_amount: parseFloat(goal.current_amount || goal.current || 0),
                        deadline: goal.deadline ? formatDate(goal.deadline) : null,
                        category: goal.category || 'savings',
                        color: goal.color || '#10b981',
                        created_at: formatDate(goal.created_at || new Date())
                    }));
                }

                // Convertir les dettes
                if (oldData.debts && Array.isArray(oldData.debts)) {
                    newData.debts = oldData.debts.map(debt => ({
                        id: debt.id || generateUUID(),
                        name: debt.name || 'Dette',
                        total_amount: parseFloat(debt.total_amount || debt.total || 0),
                        remaining_amount: parseFloat(debt.remaining_amount || debt.remaining || 0),
                        interest_rate: parseFloat(debt.interest_rate || debt.rate || 0),
                        creditor: debt.creditor || 'Cr√©ancier inconnu',
                        due_date: debt.due_date ? formatDate(debt.due_date) : null,
                        created_at: formatDate(debt.created_at || new Date())
                    }));
                }

                // Convertir les cr√©ances
                if (oldData.receivables && Array.isArray(oldData.receivables)) {
                    newData.receivables = oldData.receivables.map(rec => ({
                        id: rec.id || generateUUID(),
                        name: rec.name || 'Cr√©ance',
                        amount: parseFloat(rec.amount || 0),
                        debtor: rec.debtor || 'D√©biteur inconnu',
                        due_date: rec.due_date ? formatDate(rec.due_date) : null,
                        is_paid: rec.is_paid || rec.paid || false,
                        created_at: formatDate(rec.created_at || new Date())
                    }));
                }

                // Convertir les produits
                if (oldData.products && Array.isArray(oldData.products)) {
                    newData.products = oldData.products.map(prod => ({
                        id: prod.id || generateUUID(),
                        name: prod.name || 'Produit',
                        category: prod.category || 'general',
                        usual_price: parseFloat(prod.usual_price || prod.price || 0),
                        current_price: prod.current_price ? parseFloat(prod.current_price) : null,
                        is_on_sale: prod.is_on_sale || prod.onSale || false,
                        last_purchased_date: prod.last_purchased_date ? formatDate(prod.last_purchased_date) : null,
                        last_purchased_location: prod.last_purchased_location || prod.location || null,
                        locations: prod.locations || [],
                        notes: prod.notes || null,
                        created_at: formatDate(prod.created_at || new Date())
                    }));
                }

                const newDataText = JSON.stringify(newData, null, 2);
                document.getElementById('newData').value = newDataText;
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('importBtn').disabled = false;

                const stats = `
‚úÖ Conversion r√©ussie !
- ${newData.accounts.length} comptes
- ${newData.transactions.length} transactions
- ${newData.investments.length} investissements
- ${newData.goals.length} objectifs
- ${newData.debts.length} dettes
- ${newData.receivables.length} cr√©ances
- ${newData.products.length} produits
                `;
                showSuccess(stats);

            } catch (error) {
                showError('‚ùå Erreur de conversion : ' + error.message);
                console.error(error);
            }
        }

        function downloadJSON() {
            const data = document.getElementById('newData').value;
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financeapp-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showSuccess('‚úÖ Fichier t√©l√©charg√© ! Vous pouvez maintenant l\'importer dans FinanceApp.');
        }

        async function importToApp() {
            try {
                const data = JSON.parse(document.getElementById('newData').value);
                
                const response = await fetch('https://money-tracker-pro-2.preview.emergentagent.com/api/import/all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }

                const result = await response.json();
                showSuccess('üéâ Import r√©ussi ! ' + JSON.stringify(result.imported) + '. Rafra√Æchissez l\'application FinanceApp (F5).');
                
            } catch (error) {
                showError('‚ùå Erreur d\'import : ' + error.message + '. T√©l√©chargez le fichier et importez-le manuellement.');
            }
        }

        function formatDate(date) {
            if (!date) return new Date().toISOString();
            if (typeof date === 'string') {
                // Si d√©j√† au bon format, retourner
                if (date.includes('+') || date.endsWith('Z')) return date;
                // Sinon, parser et formater
                return new Date(date).toISOString();
            }
            return new Date(date).toISOString();
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showSuccess(message) {
            const el = document.getElementById('success');
            el.textContent = message;
            el.style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }

        function showError(message) {
            const el = document.getElementById('error');
            el.textContent = message;
            el.style.display = 'block';
            document.getElementById('success').style.display = 'none';
        }
    </script>
</body>
</html>
